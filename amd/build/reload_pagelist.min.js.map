{"version":3,"file":"reload_pagelist.min.js","sources":["../src/reload_pagelist.js"],"sourcesContent":["import {call as fetchMany} from 'core/ajax';\r\nimport Log from 'core/log';\r\nimport {exception as displayException} from 'core/notification';\r\nimport Templates from 'core/templates';\r\nimport SortableList from 'core/sortable_list';\r\nimport jQuery from 'jquery';\r\nimport {ajaxRequestInput} from 'mod_mootimeter/utils';\r\n\r\nexport const init = (pagerefreshintervall) => {\r\n    var obj = document.getElementById('mootimeterstate');\r\n\r\n    if (!obj) {\r\n        return;\r\n    }\r\n\r\n    if (pagerefreshintervall < 500) {\r\n        pagerefreshintervall = 500;\r\n    }\r\n\r\n    setInterval(() => {\r\n        getPagelist();\r\n    }, pagerefreshintervall);\r\n\r\n    /**\r\n     * Store the value.\r\n     */\r\n    function getPagelist() {\r\n        var pageid = 0;\r\n\r\n        if (document.getElementById('mootimeterstate').dataset.pageid) {\r\n            pageid = document.getElementById('mootimeterstate').dataset.pageid;\r\n            if (pageid == \"undefined\" || pageid.length == 0) {\r\n                pageid = 0;\r\n            }\r\n        }\r\n\r\n        const queryString = window.location.search;\r\n        const urlParams = new URLSearchParams(queryString);\r\n        const cmid = urlParams.get('id');\r\n        execReloadPagelist(pageid, cmid);\r\n    }\r\n};\r\n\r\n/**\r\n * Call to store input value\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {string} dataset\r\n * @returns {array}\r\n */\r\nconst reloadPagelist = (\r\n    pageid,\r\n    cmid,\r\n    dataset\r\n) => fetchMany([{\r\n    methodname: 'mod_mootimeter_get_pages_list',\r\n    args: {\r\n        pageid,\r\n        cmid,\r\n        dataset\r\n    },\r\n}])[0];\r\n\r\n/**\r\n * Executes the call to store input value.\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {bool} forcereload\r\n */\r\nexport const execReloadPagelist = async(pageid, cmid, forcereload = false) => {\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n    var dataset = mtmstate.dataset;\r\n\r\n    // Early exit if page reload is locked (e.g., during page transitions).\r\n    if (mtmstate.dataset.lockpagereload && !forcereload) {\r\n        return;\r\n    }\r\n\r\n    // Early exit if there were no changes.\r\n    if (\r\n        (\r\n            mtmstate.dataset.pagelistchangedat_prev\r\n            && mtmstate.dataset.pagelistchangedat == mtmstate.dataset.pagelistchangedat_prev\r\n        )\r\n        && !forcereload\r\n    ) {\r\n        return;\r\n    }\r\n\r\n    const queryString = window.location.search;\r\n    const urlParams = new URLSearchParams(queryString);\r\n\r\n    if (urlParams.get('r')) {\r\n        dataset.r = urlParams.get('r');\r\n    }\r\n\r\n    if (urlParams.get('o')) {\r\n        dataset.o = urlParams.get('o');\r\n    }\r\n\r\n    dataset.useUrlParams = 1;\r\n\r\n    const response = await reloadPagelist(pageid, cmid, JSON.stringify(dataset));\r\n\r\n    if (response.code != 200) {\r\n        Log.error(response.string);\r\n    }\r\n\r\n    if (response.code == 200) {\r\n\r\n        const pagelist = JSON.parse(response.pagelist);\r\n\r\n        // Replace the pages list.\r\n        Templates.renderForPromise('mod_mootimeter/elements/snippet_page_list', pagelist)\r\n            .then(({html, js}) => {\r\n                Templates.replaceNodeContents(document.getElementById('mootimeter-pages-list'), html, js);\r\n\r\n                // Finally make pageslist sortable.\r\n                var listelements = document.getElementsByClassName('mootimeter_pages_li');\r\n                if (listelements[0]) {\r\n                    var uniqid = listelements[0].dataset.uniqid;\r\n                    new SortableList('#mootimeter-pages-list', {\r\n                        moveHandlerSelector: '.mootimeter_page_move_sortablehandle_' + uniqid,\r\n                    });\r\n                    jQuery('.mootimeter_pages_li_sortable_' + uniqid).on(SortableList.EVENTS.DROP, async function(_, info) {\r\n                        var newIndex = info.targetList.children().index(info.element);\r\n                        await storePagePosition(this.dataset.pageid, newIndex);\r\n                    });\r\n                }\r\n\r\n                // Remove all tooltips of pageslist that are still present.\r\n                document.querySelectorAll('.tooltip').forEach(e => e.remove());\r\n\r\n                return true;\r\n            })\r\n            .catch((error) => displayException(error));\r\n\r\n        // Set new pagelistchangedat_prev state.\r\n        mtmstate.setAttribute('data-pagelistchangedat_prev', mtmstate.dataset.pagelistchangedat);\r\n\r\n        // Remove all tooltips of pageslist that are still present.\r\n        document.querySelectorAll('.tooltip').forEach(e => e.remove());\r\n    }\r\n};\r\n\r\n/**\r\n * Store the new page position.\r\n * @param {int} pageid\r\n * @param {int} newIndex\r\n */\r\nconst storePagePosition = (pageid, newIndex) => {\r\n    ajaxRequestInput(\r\n        'mod_mootimeter_store_page_details',\r\n        pageid,\r\n        'sortorder',\r\n        newIndex,\r\n        ''\r\n    );\r\n};\r\n"],"names":["pagerefreshintervall","document","getElementById","setInterval","pageid","dataset","length","queryString","window","location","search","cmid","URLSearchParams","get","execReloadPagelist","getPagelist","reloadPagelist","methodname","args","async","forcereload","mtmstate","lockpagereload","pagelistchangedat_prev","pagelistchangedat","urlParams","r","o","useUrlParams","response","JSON","stringify","code","error","string","pagelist","parse","renderForPromise","then","_ref","html","js","replaceNodeContents","listelements","getElementsByClassName","uniqid","SortableList","moveHandlerSelector","on","EVENTS","DROP","_","info","newIndex","targetList","children","index","element","storePagePosition","this","querySelectorAll","forEach","e","remove","catch","setAttribute"],"mappings":"knBAQqBA,uBACPC,SAASC,eAAe,qBAM9BF,qBAAuB,MACvBA,qBAAuB,KAG3BG,aAAY,qBAQJC,OAAS,EAETH,SAASC,eAAe,mBAAmBG,QAAQD,SAErC,cADdA,OAASH,SAASC,eAAe,mBAAmBG,QAAQD,SACd,GAAjBA,OAAOE,SAChCF,OAAS,UAIXG,YAAcC,OAAOC,SAASC,OAE9BC,KADY,IAAIC,gBAAgBL,aACfM,IAAI,MAC3BC,mBAAmBV,OAAQO,MAnB3BI,KACDf,8BA6BDgB,eAAiB,CACnBZ,OACAO,KACAN,WACC,cAAU,CAAC,CACZY,WAAY,gCACZC,KAAM,CACFd,OAAAA,OACAO,KAAAA,KACAN,QAAAA,YAEJ,GAQSS,mBAAqBK,eAAMf,OAAQO,UAAMS,wEAC9CC,SAAWpB,SAASC,eAAe,mBACnCG,QAAUgB,SAAShB,WAGnBgB,SAAShB,QAAQiB,iBAAmBF,sBAOhCC,SAAShB,QAAQkB,wBACdF,SAAShB,QAAQmB,mBAAqBH,SAAShB,QAAQkB,yBAE1DH,yBAKFb,YAAcC,OAAOC,SAASC,OAC9Be,UAAY,IAAIb,gBAAgBL,aAElCkB,UAAUZ,IAAI,OACdR,QAAQqB,EAAID,UAAUZ,IAAI,MAG1BY,UAAUZ,IAAI,OACdR,QAAQsB,EAAIF,UAAUZ,IAAI,MAG9BR,QAAQuB,aAAe,QAEjBC,eAAiBb,eAAeZ,OAAQO,KAAMmB,KAAKC,UAAU1B,aAE9C,KAAjBwB,SAASG,mBACLC,MAAMJ,SAASK,QAGF,KAAjBL,SAASG,KAAa,OAEhBG,SAAWL,KAAKM,MAAMP,SAASM,6BAG3BE,iBAAiB,4CAA6CF,UACnEG,MAAKC,WAACC,KAACA,KAADC,GAAOA,4BACAC,oBAAoBzC,SAASC,eAAe,yBAA0BsC,KAAMC,QAGlFE,aAAe1C,SAAS2C,uBAAuB,0BAC/CD,aAAa,GAAI,KACbE,OAASF,aAAa,GAAGtC,QAAQwC,WACjCC,uBAAa,yBAA0B,CACvCC,oBAAqB,wCAA0CF,6BAE5D,iCAAmCA,QAAQG,GAAGF,uBAAaG,OAAOC,MAAM/B,eAAegC,EAAGC,UACzFC,SAAWD,KAAKE,WAAWC,WAAWC,MAAMJ,KAAKK,eAC/CC,kBAAkBC,KAAKtD,QAAQD,OAAQiD,oBAKrDpD,SAAS2D,iBAAiB,YAAYC,SAAQC,GAAKA,EAAEC,YAE9C,KAEVC,OAAO/B,QAAU,2BAAiBA,SAGvCZ,SAAS4C,aAAa,8BAA+B5C,SAAShB,QAAQmB,mBAGtEvB,SAAS2D,iBAAiB,YAAYC,SAAQC,GAAKA,EAAEC,kEASvDL,kBAAoB,CAACtD,OAAQiD,wCAE3B,oCACAjD,OACA,YACAiD,SACA"}