{"version":3,"file":"reload_page.min.js","sources":["../src/reload_page.js"],"sourcesContent":["import {call as fetchMany} from 'core/ajax';\nimport Log from 'core/log';\nimport {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\nimport {execReloadPagelist as reloadPagelist} from 'mod_mootimeter/reload_pagelist';\n\nexport const init = (uniqueID) => {\n\n    const obj = document.getElementById(uniqueID);\n    if (!obj) {\n        return;\n    }\n    obj.addEventListener(\"click\", changePage);\n\n    /**\n     * Store the value.\n     */\n    function changePage() {\n        var pageid = this.dataset.pageid;\n        if (pageid === null || pageid === undefined || pageid == \"undefined\" || pageid.length == 0) {\n            pageid = 0;\n        }\n        const queryString = window.location.search;\n        const urlParams = new URLSearchParams(queryString);\n        const cmid = urlParams.get('id');\n        var datasetobj = this.dataset;\n        Object.assign(datasetobj, getParams());\n        execReloadPage(pageid, cmid, datasetobj);\n    }\n\n    /**\n     * Get an array of all url search params.\n     * @param {string} url\n     * @returns {array}\n     */\n    function getParams(url = window.location) {\n        // Create a params object\n        let params = {};\n        new URL(url).searchParams.forEach(function(val, key) {\n            params[key] = val;\n        });\n        return params;\n    }\n};\n\n/**\n * Call to store input value\n * @param {int} pageid\n * @param {int} cmid\n * @param {string} dataset\n * @returns {array}\n */\nconst reloadPage = (\n    pageid,\n    cmid,\n    dataset\n) => fetchMany([{\n    methodname: 'mod_mootimeter_get_pagecontentparams',\n    args: {\n        pageid,\n        cmid,\n        dataset\n    },\n}])[0];\n\n/**\n * Executes the call to store input value.\n * @param {int} pageid\n * @param {int} cmid\n * @param {array} dataset\n */\nexport const execReloadPage = async(pageid, cmid, dataset) => {\n\n    // Add all url parameters to dataset.\n    if (dataset.useUrlParams) {\n        const searchParams = new URL(window.location.href).searchParams;\n        searchParams.forEach((value, name) => {\n            dataset[name] = value;\n        });\n    }\n\n    dataset = JSON.stringify(dataset);\n    const response = await reloadPage(pageid, cmid, dataset);\n\n    if (response.code != 200) {\n        Log.error(response.string);\n    }\n\n    if (response.code == 200) {\n\n        var mtmstate = document.getElementById('mootimeterstate');\n\n        const pageparmas = JSON.parse(response.pageparams);\n\n        // Replace the pagecontent.\n        Templates.renderForPromise(pageparmas.pagecontent.template, pageparmas.pagecontent)\n            .then(({html, js}) => {\n                Templates.replaceNodeContents('#mootimeter-pagecontent', html, js);\n                return true;\n            })\n            .catch((error) => displayException(error));\n\n        // Replace the pagecontent menu.\n        if (pageparmas.contentmenu) {\n            Templates.renderForPromise(pageparmas.contentmenu.template, pageparmas.contentmenu)\n                .then(({html, js}) => {\n                    Templates.replaceNode('#mootimeter-pagecontentmenu', html, js);\n                    return true;\n                })\n                .catch((error) => displayException(error));\n\n                // Set subpage URL parameters.\n            if (pageparmas.contentmenu.sp) {\n                var container = document.querySelector(\".mootimetercontainer\");\n                for (const [key, value] of Object.entries(pageparmas.contentmenu.sp)) {\n                    setGetParam(key, value);\n                    setFullscreenClass(container, key, value);\n                }\n            }\n        }\n\n        // Replace the settings col if necessary.\n        if (pageparmas.colsettings) {\n            Templates.renderForPromise(pageparmas.colsettings.template, pageparmas.colsettings)\n                .then(({html, js}) => {\n                    Templates.replaceNodeContents('#mootimeter-col-settings', html, js);\n                    return true;\n                })\n                .catch((error) => displayException(error));\n        }\n\n        if (pageparmas.pageid) {\n\n            // Set new pageid.\n            mtmstate.setAttribute('data-pageid', pageparmas.pageid);\n\n            // Set URL parameter - pageid.\n            setGetParam('pageid', pageparmas.pageid);\n\n        }\n\n        // Set active page marked in pageslist.\n        reloadPagelist(pageid, cmid, true);\n\n\n        // Remove all tooltips of pageslist that are still present.\n        document.querySelectorAll('.tooltip').forEach(e => e.remove());\n    }\n};\n\n/**\n * Set the Query Parameter.\n * @param {string} key\n * @param {string} value\n */\nfunction setGetParam(key, value) {\n    if (history.pushState) {\n        var params = new URLSearchParams(window.location.search);\n        params.set(key, value);\n        var newUrl = window.location.origin\n            + window.location.pathname\n            + '?' + params.toString();\n        window.history.pushState({path: newUrl}, '', newUrl);\n    }\n}\n\n/**\n * Set the fullscreen class to the mootimetercontainr\n * @param {mixed} container\n * @param {string} key\n * @param {int} value\n */\nfunction setFullscreenClass(container, key, value) {\n    if (key == 'f' && value == 1) {\n        container.classList.add(\"fullscreen\");\n    } else if (key == 'f' && value == 0) {\n        container.classList.remove(\"fullscreen\");\n    }\n}"],"names":["uniqueID","obj","document","getElementById","addEventListener","pageid","this","dataset","length","queryString","window","location","search","cmid","URLSearchParams","get","datasetobj","Object","assign","url","params","URL","searchParams","forEach","val","key","getParams","execReloadPage","async","useUrlParams","href","value","name","JSON","stringify","response","methodname","args","reloadPage","code","error","string","mtmstate","pageparmas","parse","pageparams","renderForPromise","pagecontent","template","then","_ref","html","js","replaceNodeContents","catch","contentmenu","_ref2","replaceNode","sp","container","querySelector","entries","setGetParam","setFullscreenClass","colsettings","_ref3","setAttribute","querySelectorAll","e","remove","history","pushState","set","newUrl","origin","pathname","toString","path","classList","add"],"mappings":"2eAMqBA,iBAEXC,IAAMC,SAASC,eAAeH,UAC/BC,KAGLA,IAAIG,iBAAiB,wBAMbC,OAASC,KAAKC,QAAQF,OACtBA,MAAAA,QAAqD,aAAVA,QAA0C,GAAjBA,OAAOG,SAC3EH,OAAS,SAEPI,YAAcC,OAAOC,SAASC,OAE9BC,KADY,IAAIC,gBAAgBL,aACfM,IAAI,UACvBC,WAAaV,KAAKC,QACtBU,OAAOC,OAAOF,0BASCG,2DAAMT,OAAOC,SAExBS,OAAS,cACTC,IAAIF,KAAKG,aAAaC,SAAQ,SAASC,IAAKC,KAC5CL,OAAOK,KAAOD,OAEXJ,OAfmBM,IAC1BC,eAAetB,OAAQQ,KAAMG,sBA4CxBW,eAAiBC,MAAMvB,OAAQQ,KAAMN,cAG1CA,QAAQsB,aAAc,CACD,IAAIR,IAAIX,OAAOC,SAASmB,MAAMR,aACtCC,SAAQ,CAACQ,MAAOC,QACzBzB,QAAQyB,MAAQD,SAIxBxB,QAAU0B,KAAKC,UAAU3B,eACnB4B,cA9BS,EACf9B,OACAQ,KACAN,WACC,cAAU,CAAC,CACZ6B,WAAY,uCACZC,KAAM,CACFhC,OAAAA,OACAQ,KAAAA,KACAN,QAAAA,YAEJ,GAmBuB+B,CAAWjC,OAAQQ,KAAMN,YAE3B,KAAjB4B,SAASI,mBACLC,MAAML,SAASM,QAGF,KAAjBN,SAASI,KAAa,KAElBG,SAAWxC,SAASC,eAAe,yBAEjCwC,WAAaV,KAAKW,MAAMT,SAASU,kCAG7BC,iBAAiBH,WAAWI,YAAYC,SAAUL,WAAWI,aAClEE,MAAKC,WAACC,KAACA,KAADC,GAAOA,mCACAC,oBAAoB,0BAA2BF,KAAMC,KACxD,KAEVE,OAAOd,QAAU,2BAAiBA,SAGnCG,WAAWY,iCACDT,iBAAiBH,WAAWY,YAAYP,SAAUL,WAAWY,aAClEN,MAAKO,YAACL,KAACA,KAADC,GAAOA,oCACAK,YAAY,8BAA+BN,KAAMC,KACpD,KAEVE,OAAOd,QAAU,2BAAiBA,SAGnCG,WAAWY,YAAYG,IAAI,KACvBC,UAAYzD,SAAS0D,cAAc,4BAClC,MAAOnC,IAAKM,SAAUd,OAAO4C,QAAQlB,WAAWY,YAAYG,IAC7DI,YAAYrC,IAAKM,OACjBgC,mBAAmBJ,UAAWlC,IAAKM,OAM3CY,WAAWqB,gCACDlB,iBAAiBH,WAAWqB,YAAYhB,SAAUL,WAAWqB,aAClEf,MAAKgB,YAACd,KAACA,KAADC,GAAOA,oCACAC,oBAAoB,2BAA4BF,KAAMC,KACzD,KAEVE,OAAOd,QAAU,2BAAiBA,SAGvCG,WAAWtC,SAGXqC,SAASwB,aAAa,cAAevB,WAAWtC,QAGhDyD,YAAY,SAAUnB,WAAWtC,iDAKtBA,OAAQQ,MAAM,GAI7BX,SAASiE,iBAAiB,YAAY5C,SAAQ6C,GAAKA,EAAEC,sBASpDP,YAAYrC,IAAKM,UAClBuC,QAAQC,UAAW,KACfnD,OAAS,IAAIN,gBAAgBJ,OAAOC,SAASC,QACjDQ,OAAOoD,IAAI/C,IAAKM,WACZ0C,OAAS/D,OAAOC,SAAS+D,OACvBhE,OAAOC,SAASgE,SAChB,IAAMvD,OAAOwD,WACnBlE,OAAO4D,QAAQC,UAAU,CAACM,KAAMJ,QAAS,GAAIA,kBAU5CV,mBAAmBJ,UAAWlC,IAAKM,OAC7B,KAAPN,KAAuB,GAATM,MACd4B,UAAUmB,UAAUC,IAAI,cACV,KAAPtD,KAAuB,GAATM,OACrB4B,UAAUmB,UAAUT,OAAO"}