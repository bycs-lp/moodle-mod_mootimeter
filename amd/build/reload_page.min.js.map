{"version":3,"file":"reload_page.min.js","sources":["../src/reload_page.js"],"sourcesContent":["import {call as fetchMany} from 'core/ajax';\r\nimport Log from 'core/log';\r\nimport {exception as displayException} from 'core/notification';\r\nimport Templates from 'core/templates';\r\nimport {execReloadPagelist as reloadPagelist} from 'mod_mootimeter/reload_pagelist';\r\nimport {getGetParams} from 'mod_mootimeter/utils';\r\nimport {setGetParam} from 'mod_mootimeter/utils';\r\nimport {getMootimeterstate} from 'mod_mootimeter/get_mootimeterstate';\r\n\r\nexport const init = (uniqueID) => {\r\n\r\n    const obj = document.getElementById(uniqueID);\r\n    if (!obj) {\r\n        return;\r\n    }\r\n    obj.addEventListener(\"click\", changePage);\r\n\r\n    /**\r\n     * Store the value.\r\n     */\r\n    function changePage() {\r\n        var pageid = 0;\r\n        var dataset = \"\";\r\n        if (this.dataset) {\r\n            pageid = this.dataset.pageid;\r\n            dataset = this.dataset;\r\n        }\r\n\r\n        if (pageid === null || pageid === undefined || pageid == \"undefined\" || pageid.length == 0) {\r\n            pageid = 0;\r\n        }\r\n\r\n        const queryString = window.location.search;\r\n        const urlParams = new URLSearchParams(queryString);\r\n        const cmid = urlParams.get('id');\r\n        execReloadPage(pageid, cmid, dataset);\r\n    }\r\n};\r\n\r\n/**\r\n * Call to store input value\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {string} dataset\r\n * @returns {array}\r\n */\r\nconst reloadPage = (\r\n    pageid,\r\n    cmid,\r\n    dataset\r\n) => fetchMany([{\r\n    methodname: 'mod_mootimeter_get_pagecontentparams',\r\n    args: {\r\n        pageid,\r\n        cmid,\r\n        dataset\r\n    },\r\n}])[0];\r\n\r\n/**\r\n * Executes the call to store input value.\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {array} dataset\r\n */\r\nexport const execReloadPage = async(pageid, cmid, dataset) => {\r\n\r\n    // Check if the pagereload is locked.\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n    if (mtmstate.dataset.lockpagereload) {\r\n        return;\r\n    }\r\n\r\n    // Lock page reload during transition to prevent race conditions.\r\n    mtmstate.setAttribute('data-lockpagereload', '1');\r\n\r\n    if (!dataset) {\r\n        dataset = getGetParams();\r\n    } else {\r\n        Object.assign(dataset, getGetParams());\r\n    }\r\n\r\n    dataset = JSON.stringify(dataset);\r\n\r\n    // Get the most recent timestamps.\r\n    if (pageid != 0) {\r\n        await getMootimeterstate();\r\n    }\r\n\r\n    mtmstate = document.getElementById('mootimeterstate');\r\n\r\n    const response = await reloadPage(pageid, cmid, dataset);\r\n    if (response.code != 200) {\r\n        Log.error(response.string);\r\n    }\r\n\r\n    if (response.code == 200) {\r\n\r\n        const pageparmas = JSON.parse(response.pageparams);\r\n\r\n        // Replace the pagecontent.\r\n        if (\r\n            !mtmstate.dataset.contentchangedat_prev\r\n            || mtmstate.dataset.contentchangedat_prev != mtmstate.contentchangedat\r\n            || !mtmstate.dataset.teacherpermissiontoview_prev\r\n            || mtmstate.dataset.teacherpermissiontoview_prev != mtmstate.dataset.teacherpermissiontoviewteacherpermissiontoview\r\n        ) {\r\n            reloadPageContent(pageparmas.pagecontent);\r\n\r\n            // Set active page marked in pageslist.\r\n            reloadPagelist(pageid, cmid, true);\r\n        }\r\n\r\n        // Replace the pagecontent menu.\r\n        if (\r\n            !mtmstate.dataset.pagecontentmenuchangedat_prev\r\n            || mtmstate.dataset.pagecontentmenuchangedat_prev != mtmstate.settingschangedat\r\n        ) {\r\n            if (pageparmas.contentmenu) {\r\n                reloadContentMenu(pageparmas.contentmenu);\r\n            }\r\n        }\r\n\r\n        if (\r\n            pageparmas.colsettings\r\n            && (\r\n                !mtmstate.dataset.settingschangedat_prev\r\n                || mtmstate.dataset.settingschangedat_prev != mtmstate.settingschangedat\r\n            )\r\n        ) {\r\n            reloadSettingsCol(pageparmas.colsettings);\r\n        }\r\n\r\n        if (pageparmas.pageid) {\r\n            // Set new pageid.\r\n            mtmstate.setAttribute('data-pageid', pageparmas.pageid);\r\n\r\n            // Set URL parameter - pageid.\r\n            setGetParam('pageid', pageparmas.pageid);\r\n        }\r\n\r\n        // Unlock page reload after transition is complete.\r\n        mtmstate.setAttribute('data-lockpagereload', '');\r\n    }\r\n};\r\n\r\nexport const reloadSettingsCol = async(pageparmas) => {\r\n\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n\r\n    // Replace the settings col if necessary.\r\n    Templates.renderForPromise(pageparmas.template, pageparmas)\r\n        .then(({html, js}) => {\r\n            Templates.replaceNodeContents('#mootimeter-col-settings', html, js);\r\n            mtmstate.setAttribute('data-settingschangedat_prev', mtmstate.dataset.settingschangedat);\r\n            return true;\r\n        })\r\n        .catch((error) => displayException(error));\r\n\r\n};\r\n\r\nexport const reloadContentMenu = async(pageparmas) => {\r\n\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n\r\n    // Replace the settings col if necessary.\r\n    Templates.renderForPromise(pageparmas.template, pageparmas)\r\n        .then(({html, js}) => {\r\n            Templates.replaceNode('#mootimeter-pagecontentmenu', html, js);\r\n            mtmstate.setAttribute('data-pagecontentmenuchangedat_prev', mtmstate.dataset.pagecontentmenuchangedat);\r\n            return true;\r\n        })\r\n        .catch((error) => displayException(error));\r\n\r\n    // Set subpage URL parameters.\r\n    if (pageparmas.sp) {\r\n        for (const [key, value] of Object.entries(pageparmas.sp)) {\r\n            setGetParam(key, value);\r\n        }\r\n    }\r\n};\r\n\r\nexport const reloadPageContent = async(pageparmas) => {\r\n\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n\r\n    Templates.renderForPromise(pageparmas.template, pageparmas)\r\n        .then(({html, js}) => {\r\n            Templates.replaceNodeContents('#mootimeter-pagecontent', html, js);\r\n            mtmstate.setAttribute('data-contentchangedat_prev', mtmstate.dataset.contentchangedat);\r\n            mtmstate.setAttribute('data-teacherpermissiontoview_prev', mtmstate.dataset.teacherpermissiontoview);\r\n            return true;\r\n        })\r\n        .catch((error) => displayException(error));\r\n};\r\n"],"names":["uniqueID","obj","document","getElementById","addEventListener","pageid","dataset","this","length","queryString","window","location","search","cmid","URLSearchParams","get","execReloadPage","async","mtmstate","lockpagereload","setAttribute","Object","assign","JSON","stringify","response","methodname","args","reloadPage","code","error","string","pageparmas","parse","pageparams","contentchangedat_prev","contentchangedat","teacherpermissiontoview_prev","teacherpermissiontoviewteacherpermissiontoview","reloadPageContent","pagecontent","pagecontentmenuchangedat_prev","settingschangedat","contentmenu","reloadContentMenu","colsettings","settingschangedat_prev","reloadSettingsCol","renderForPromise","template","then","_ref","html","js","replaceNodeContents","catch","_ref2","replaceNode","pagecontentmenuchangedat","sp","key","value","entries","_ref3","teacherpermissiontoview"],"mappings":"opBASqBA,iBAEXC,IAAMC,SAASC,eAAeH,UAC/BC,KAGLA,IAAIG,iBAAiB,wBAMbC,OAAS,EACTC,QAAU,GACVC,KAAKD,UACLD,OAASE,KAAKD,QAAQD,OACtBC,QAAUC,KAAKD,SAGfD,MAAAA,QAAqD,aAAVA,QAA0C,GAAjBA,OAAOG,SAC3EH,OAAS,SAGPI,YAAcC,OAAOC,SAASC,OAE9BC,KADY,IAAIC,gBAAgBL,aACfM,IAAI,MAC3BC,eAAeX,OAAQQ,KAAMP,mBA8BxBU,eAAiBC,MAAMZ,OAAQQ,KAAMP,eAG1CY,SAAWhB,SAASC,eAAe,sBACnCe,SAASZ,QAAQa,sBAKrBD,SAASE,aAAa,sBAAuB,KAExCd,QAGDe,OAAOC,OAAOhB,SAAS,0BAFvBA,SAAU,yBAKdA,QAAUiB,KAAKC,UAAUlB,SAGX,GAAVD,cACM,6CAGVa,SAAWhB,SAASC,eAAe,yBAE7BsB,cA7CS,EACfpB,OACAQ,KACAP,WACC,cAAU,CAAC,CACZoB,WAAY,uCACZC,KAAM,CACFtB,OAAAA,OACAQ,KAAAA,KACAP,QAAAA,YAEJ,GAkCuBsB,CAAWvB,OAAQQ,KAAMP,YAC3B,KAAjBmB,SAASI,mBACLC,MAAML,SAASM,QAGF,KAAjBN,SAASI,KAAa,OAEhBG,WAAaT,KAAKU,MAAMR,SAASS,YAIlChB,SAASZ,QAAQ6B,uBACfjB,SAASZ,QAAQ6B,uBAAyBjB,SAASkB,kBAClDlB,SAASZ,QAAQ+B,8BAClBnB,SAASZ,QAAQ+B,8BAAgCnB,SAASZ,QAAQgC,iDAErEC,kBAAkBP,WAAWQ,qDAGdnC,OAAQQ,MAAM,IAK5BK,SAASZ,QAAQmC,+BACfvB,SAASZ,QAAQmC,+BAAiCvB,SAASwB,mBAE1DV,WAAWW,aACXC,kBAAkBZ,WAAWW,cAKjCX,WAAWa,aAEN3B,SAASZ,QAAQwC,wBACf5B,SAASZ,QAAQwC,wBAA0B5B,SAASwB,mBAG3DK,kBAAkBf,WAAWa,aAG7Bb,WAAW3B,SAEXa,SAASE,aAAa,cAAeY,WAAW3B,+BAGpC,SAAU2B,WAAW3B,SAIrCa,SAASE,aAAa,sBAAuB,mDAIxC2B,kBAAoB9B,MAAAA,iBAEzBC,SAAWhB,SAASC,eAAe,sCAG7B6C,iBAAiBhB,WAAWiB,SAAUjB,YAC3CkB,MAAKC,WAACC,KAACA,KAADC,GAAOA,mCACAC,oBAAoB,2BAA4BF,KAAMC,IAChEnC,SAASE,aAAa,8BAA+BF,SAASZ,QAAQoC,oBAC/D,KAEVa,OAAOzB,QAAU,2BAAiBA,6DAI9Bc,kBAAoB3B,MAAAA,iBAEzBC,SAAWhB,SAASC,eAAe,yCAG7B6C,iBAAiBhB,WAAWiB,SAAUjB,YAC3CkB,MAAKM,YAACJ,KAACA,KAADC,GAAOA,oCACAI,YAAY,8BAA+BL,KAAMC,IAC3DnC,SAASE,aAAa,qCAAsCF,SAASZ,QAAQoD,2BACtE,KAEVH,OAAOzB,QAAU,2BAAiBA,SAGnCE,WAAW2B,OACN,MAAOC,IAAKC,SAAUxC,OAAOyC,QAAQ9B,WAAW2B,2BACrCC,IAAKC,2DAKhBtB,kBAAoBtB,MAAAA,iBAEzBC,SAAWhB,SAASC,eAAe,sCAE7B6C,iBAAiBhB,WAAWiB,SAAUjB,YAC3CkB,MAAKa,YAACX,KAACA,KAADC,GAAOA,oCACAC,oBAAoB,0BAA2BF,KAAMC,IAC/DnC,SAASE,aAAa,6BAA8BF,SAASZ,QAAQ8B,kBACrElB,SAASE,aAAa,oCAAqCF,SAASZ,QAAQ0D,0BACrE,KAEVT,OAAOzB,QAAU,2BAAiBA"}