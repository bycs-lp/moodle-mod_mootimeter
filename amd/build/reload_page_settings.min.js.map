{"version":3,"file":"reload_page_settings.min.js","sources":["../src/reload_page_settings.js"],"sourcesContent":["import {call as fetchMany} from 'core/ajax';\r\nimport Log from 'core/log';\r\nimport {exception as displayException} from 'core/notification';\r\nimport Templates from 'core/templates';\r\nimport {execReloadPagelist as reloadPagelist} from 'mod_mootimeter/reload_pagelist';\r\nimport {getMootimeterstate} from 'mod_mootimeter/get_mootimeterstate';\r\n\r\nexport const init = (uniqueID) => {\r\n\r\n    const obj = document.getElementById(uniqueID);\r\n    if (!obj) {\r\n        return;\r\n    }\r\n    obj.addEventListener(\"change\", changePage);\r\n\r\n    /**\r\n     * Store the value.\r\n     */\r\n    function changePage() {\r\n        var pageid = this.dataset.pageid;\r\n        const queryString = window.location.search;\r\n        const urlParams = new URLSearchParams(queryString);\r\n        const cmid = urlParams.get('id');\r\n        execReloadPage(pageid, cmid, this.dataset);\r\n    }\r\n};\r\n\r\n/**\r\n * Call to store input value\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {string} dataset\r\n * @returns {array}\r\n */\r\nconst reloadPage = (\r\n    pageid,\r\n    cmid,\r\n    dataset\r\n) => fetchMany([{\r\n    methodname: 'mod_mootimeter_get_pagecontentparams',\r\n    args: {\r\n        pageid,\r\n        cmid,\r\n        dataset\r\n    },\r\n}])[0];\r\n\r\n/**\r\n * Executes the call to store input value.\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {array} dataset\r\n */\r\nconst execReloadPage = async(pageid, cmid, dataset) => {\r\n\r\n    if (!dataset) {\r\n        dataset = JSON.stringify([]);\r\n    } else {\r\n        dataset = JSON.stringify(dataset);\r\n    }\r\n\r\n    // Get the most recent timestamps.\r\n    await getMootimeterstate();\r\n\r\n    const response = await reloadPage(pageid, cmid, dataset);\r\n\r\n    if (response.code != 200) {\r\n        Log.error(response.string);\r\n    }\r\n\r\n    if (response.code == 200) {\r\n        var mtmstate = document.getElementById('mootimeterstate');\r\n        const pageparmas = JSON.parse(response.pageparams);\r\n\r\n        // Set new pageid.\r\n        mtmstate.setAttribute('data-pageid', pageparmas.pageid);\r\n\r\n        // Replace the settings col if necessary.\r\n        Templates.renderForPromise(pageparmas.colsettings.template, pageparmas.colsettings)\r\n            .then(({html, js}) => {\r\n                Templates.replaceNodeContents('#mootimeter-col-settings', html, js);\r\n                mtmstate.setAttribute('data-settingschangedat_prev', mtmstate.dataset.settingschangedat);\r\n                return true;\r\n            })\r\n            .catch((error) => displayException(error));\r\n\r\n        // Set URL parameter.\r\n        setGetParam('pageid', pageparmas.pageid);\r\n\r\n        // Set active page marked in pageslist.\r\n        reloadPagelist(pageid, cmid, true);\r\n\r\n        // Remove all tooltips of pageslist that are still present.\r\n        document.querySelectorAll('.tooltip').forEach(e => e.remove());\r\n    }\r\n};\r\n\r\n/**\r\n * Set the Query Parameter.\r\n * @param {string} key\r\n * @param {string} value\r\n */\r\nfunction setGetParam(key, value) {\r\n    if (history.pushState) {\r\n        var params = new URLSearchParams(window.location.search);\r\n        params.set(key, value);\r\n        var newUrl = window.location.origin\r\n            + window.location.pathname\r\n            + '?' + params.toString();\r\n        window.history.pushState({path: newUrl}, '', newUrl);\r\n    }\r\n}\r\n"],"names":["uniqueID","obj","document","getElementById","addEventListener","pageid","this","dataset","queryString","window","location","search","cmid","URLSearchParams","get","execReloadPage","async","JSON","stringify","response","methodname","args","reloadPage","code","error","string","mtmstate","pageparmas","parse","pageparams","setAttribute","renderForPromise","colsettings","template","then","_ref","html","js","replaceNodeContents","settingschangedat","catch","key","value","history","pushState","params","set","newUrl","origin","pathname","toString","path","setGetParam","querySelectorAll","forEach","e","remove"],"mappings":"shBAOqBA,iBAEXC,IAAMC,SAASC,eAAeH,UAC/BC,KAGLA,IAAIG,iBAAiB,yBAMbC,OAASC,KAAKC,QAAQF,aACpBG,YAAcC,OAAOC,SAASC,OAE9BC,KADY,IAAIC,gBAAgBL,aACfM,IAAI,MAC3BC,eAAeV,OAAQO,KAAMN,KAAKC,mBA8BpCQ,eAAiBC,MAAMX,OAAQO,KAAML,WAKnCA,QAHCA,QAGSU,KAAKC,UAAUX,SAFfU,KAAKC,UAAU,UAMvB,mDAEAC,cA9BS,EACfd,OACAO,KACAL,WACC,cAAU,CAAC,CACZa,WAAY,uCACZC,KAAM,CACFhB,OAAAA,OACAO,KAAAA,KACAL,QAAAA,YAEJ,GAmBuBe,CAAWjB,OAAQO,KAAML,YAE3B,KAAjBY,SAASI,mBACLC,MAAML,SAASM,QAGF,KAAjBN,SAASI,KAAa,KAClBG,SAAWxB,SAASC,eAAe,yBACjCwB,WAAaV,KAAKW,MAAMT,SAASU,YAGvCH,SAASI,aAAa,cAAeH,WAAWtB,2BAGtC0B,iBAAiBJ,WAAWK,YAAYC,SAAUN,WAAWK,aAClEE,MAAKC,WAACC,KAACA,KAADC,GAAOA,mCACAC,oBAAoB,2BAA4BF,KAAMC,IAChEX,SAASI,aAAa,8BAA+BJ,SAASnB,QAAQgC,oBAC/D,KAEVC,OAAOhB,QAAU,2BAAiBA,kBAkB1BiB,IAAKC,UAClBC,QAAQC,UAAW,KACfC,OAAS,IAAIhC,gBAAgBJ,OAAOC,SAASC,QACjDkC,OAAOC,IAAIL,IAAKC,WACZK,OAAStC,OAAOC,SAASsC,OACvBvC,OAAOC,SAASuC,SAChB,IAAMJ,OAAOK,WACnBzC,OAAOkC,QAAQC,UAAU,CAACO,KAAMJ,QAAS,GAAIA,SAtB7CK,CAAY,SAAUzB,WAAWtB,gDAGlBA,OAAQO,MAAM,GAG7BV,SAASmD,iBAAiB,YAAYC,SAAQC,GAAKA,EAAEC"}