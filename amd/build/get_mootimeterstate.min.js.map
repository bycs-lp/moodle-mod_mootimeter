{"version":3,"file":"get_mootimeterstate.min.js","sources":["../src/get_mootimeterstate.js"],"sourcesContent":["import {call as fetchMany} from 'core/ajax';\r\nimport Log from 'core/log';\r\nimport {execReloadPage as reloadPage} from 'mod_mootimeter/reload_page';\r\n\r\nexport const init = (refreshintervall) => {\r\n\r\n    var obj = document.getElementById('mootimeterstate');\r\n    if (!obj) {\r\n        window.console.log(\"Early exit\");\r\n        return;\r\n    }\r\n\r\n    if (refreshintervall < 1000) {\r\n        refreshintervall = 1000;\r\n    }\r\n\r\n    initMootimeterstate();\r\n\r\n    setInterval(() => {\r\n        getMootimeterstate();\r\n    }, refreshintervall);\r\n};\r\n\r\n/**\r\n * Make the call to get the Mootimeterstate\r\n * @param {int} pageid\r\n * @param {int} cmid\r\n * @param {string} dataset\r\n * @returns {array}\r\n */\r\nconst getMootimeterstateExecute = (\r\n    pageid,\r\n    cmid,\r\n    dataset\r\n) => fetchMany([{\r\n    methodname: 'mod_mootimeter_get_mootimeterstate',\r\n    args: {\r\n        pageid,\r\n        cmid,\r\n        dataset\r\n    },\r\n}])[0];\r\n\r\nconst initMootimeterstate = async() => {\r\n\r\n    await getMootimeterstate();\r\n\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n    var dataset = mtmstate.dataset;\r\n    const queryString = window.location.search;\r\n    const urlParams = new URLSearchParams(queryString);\r\n    const cmid = urlParams.get('id');\r\n\r\n    if (urlParams.get('r')) {\r\n        dataset.r = urlParams.get('r');\r\n    }\r\n\r\n    if (urlParams.get('o')) {\r\n        dataset.o = urlParams.get('o');\r\n    }\r\n\r\n    var pageid = 0;\r\n    if (dataset.pageid) {\r\n        pageid = dataset.pageid;\r\n    } else if (urlParams.get('pageid')) {\r\n        pageid = urlParams.get('pageid');\r\n    }\r\n\r\n    await reloadPage(pageid, cmid, dataset);\r\n};\r\n\r\n/**\r\n * Executes the call to store input value.\r\n */\r\nexport const getMootimeterstate = async() => {\r\n    var mtmstate = document.getElementById('mootimeterstate');\r\n    var dataset = mtmstate.dataset;\r\n    const queryString = window.location.search;\r\n    const urlParams = new URLSearchParams(queryString);\r\n    const cmid = urlParams.get('id');\r\n\r\n    if (urlParams.get('r')) {\r\n        dataset.r = urlParams.get('r');\r\n    }\r\n\r\n    if (urlParams.get('o')) {\r\n        dataset.o = urlParams.get('o');\r\n    }\r\n\r\n    var pageid = 0;\r\n    if (dataset.pageid) {\r\n        pageid = dataset.pageid;\r\n    } else if (urlParams.get('pageid')) {\r\n        pageid = urlParams.get('pageid');\r\n    }\r\n\r\n    const response = await getMootimeterstateExecute(pageid, cmid, JSON.stringify(dataset));\r\n\r\n    if (response.code != 200) {\r\n        Log.error(response.string);\r\n    }\r\n\r\n    if (response.code == 200) {\r\n        const states = JSON.parse(response.state);\r\n\r\n        // Set all datasets to mootimeterstate.\r\n        for (let dataattribute in states) {\r\n            mtmstate.setAttribute('data-' + dataattribute, states[dataattribute]);\r\n        }\r\n\r\n        if (mtmstate.dataset.contentchangedat_prev != mtmstate.dataset.contentchangedat) {\r\n            mtmstate.setAttribute('data-settingschangedat_prev', 0);\r\n            mtmstate.setAttribute('data-contentlastupdated', 0);\r\n            reloadPage(pageid, cmid, dataset);\r\n        }\r\n    }\r\n\r\n};\r\n"],"names":["refreshintervall","document","getElementById","initMootimeterstate","setInterval","getMootimeterstate","window","console","log","async","dataset","queryString","location","search","urlParams","URLSearchParams","cmid","get","r","o","pageid","mtmstate","response","methodname","args","getMootimeterstateExecute","JSON","stringify","code","error","string","states","parse","state","dataattribute","setAttribute","contentchangedat_prev","contentchangedat"],"mappings":"yUAIqBA,mBAEPC,SAASC,eAAe,oBAM9BF,iBAAmB,MACnBA,iBAAmB,KAGvBG,sBAEAC,aAAY,KACRC,uBACDL,mBAZCM,OAAOC,QAAQC,IAAI,qBAmCrBL,oBAAsBM,gBAElBJ,yBAGFK,QADWT,SAASC,eAAe,mBAChBQ,cACjBC,YAAcL,OAAOM,SAASC,OAC9BC,UAAY,IAAIC,gBAAgBJ,aAChCK,KAAOF,UAAUG,IAAI,MAEvBH,UAAUG,IAAI,OACdP,QAAQQ,EAAIJ,UAAUG,IAAI,MAG1BH,UAAUG,IAAI,OACdP,QAAQS,EAAIL,UAAUG,IAAI,UAG1BG,OAAS,EACTV,QAAQU,OACRA,OAASV,QAAQU,OACVN,UAAUG,IAAI,YACrBG,OAASN,UAAUG,IAAI,iBAGrB,+BAAWG,OAAQJ,KAAMN,UAMtBL,mBAAqBI,cAC1BY,SAAWpB,SAASC,eAAe,mBACnCQ,QAAUW,SAASX,cACjBC,YAAcL,OAAOM,SAASC,OAC9BC,UAAY,IAAIC,gBAAgBJ,aAChCK,KAAOF,UAAUG,IAAI,MAEvBH,UAAUG,IAAI,OACdP,QAAQQ,EAAIJ,UAAUG,IAAI,MAG1BH,UAAUG,IAAI,OACdP,QAAQS,EAAIL,UAAUG,IAAI,UAG1BG,OAAS,EACTV,QAAQU,OACRA,OAASV,QAAQU,OACVN,UAAUG,IAAI,YACrBG,OAASN,UAAUG,IAAI,iBAGrBK,cAlEwB,EAC9BF,OACAJ,KACAN,WACC,cAAU,CAAC,CACZa,WAAY,qCACZC,KAAM,CACFJ,OAAAA,OACAJ,KAAAA,KACAN,QAAAA,YAEJ,GAuDuBe,CAA0BL,OAAQJ,KAAMU,KAAKC,UAAUjB,aAEzD,KAAjBY,SAASM,mBACLC,MAAMP,SAASQ,QAGF,KAAjBR,SAASM,KAAa,OAChBG,OAASL,KAAKM,MAAMV,SAASW,WAG9B,IAAIC,iBAAiBH,OACtBV,SAASc,aAAa,QAAUD,cAAeH,OAAOG,gBAGtDb,SAASX,QAAQ0B,uBAAyBf,SAASX,QAAQ2B,mBAC3DhB,SAASc,aAAa,8BAA+B,GACrDd,SAASc,aAAa,0BAA2B,mCACtCf,OAAQJ,KAAMN"}