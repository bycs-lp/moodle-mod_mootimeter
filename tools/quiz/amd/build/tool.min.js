define("mootimetertool_quiz/tool",["exports","core/ajax","mod_mootimeter/tool","core/notification","core/templates","mod_mootimeter/toolmanager","core/chartjs","mod_mootimeter/util"],(function(_exports,_ajax,_tool,_notification,_templates,_toolmanager,_chartjs,Util){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Super class for tools.
   *
   * @module     mootimetertool_quiz/tool
   * @copyright  2023 Justus Dieckmann WWU
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_tool=_interopRequireDefault(_tool),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_chartjs=_interopRequireDefault(_chartjs),Util=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Util);class Tool extends _tool.default{async render(){_templates.default.prefetchTemplates(["mootimetertool_quiz/view_content"]);const page=this.page,answeroptions=await _ajax.default.call([{methodname:"mootimetertool_quiz_get_answeroptions",args:{pageid:page.id},fail:_notification.default.exception}])[0],context={question_text:page.question,pageid:page.id,ispoll:"1"===page.config.ispoll,isquiz:"1"!==page.config.ispoll,answer_options:answeroptions.map((option=>({aoid:option.id,ao_text:option.optiontext,ao_iscorrect:option.optioniscorrect}))),isediting:this.isEditing},element=await Util.renderTemplate("mootimetertool_quiz/view_content",context);return this.isEditing||element.querySelectorAll(".mtmt_answeroption").forEach((answerOptionEl=>{answerOptionEl.onclick=async()=>{await _ajax.default.call([{methodname:"mootimetertool_quiz_store_answer",args:{pageid:page.id,aoid:answerOptionEl.dataset.aoid},fail:_notification.default.exception}])[0],_toolmanager.ToolManager.route(page.id,!0)}})),this.isEditing&&(this.saveAnswerOptionTextsWhenChanged(element.firstElementChild),this.addNewAnswerOptionOnButtonClick(element.firstElementChild)),element}saveAnswerOptionTextsWhenChanged(element){element.addEventListener("blur",(e=>{if(e.target.matches("textarea.mtmt-delayed-store")){const aoid=e.target.closest("[data-aoid]").dataset.aoid;_ajax.default.call([{methodname:"mootimetertool_quiz_store_answeroption",args:{aoid:aoid,value:e.target.value},fail:_notification.default.exception}])}}),!0)}addNewAnswerOptionOnButtonClick(element){_templates.default.prefetchTemplates(["mootimetertool_quiz/answer_option"]);const newAOButton=element.querySelector("#new_ao_label"),questionElements=element.querySelector("#mtmt_questions");newAOButton.onclick=async()=>{const result=await _ajax.default.call([{methodname:"mootimetertool_quiz_new_answeroption",args:{pageid:this.page.id},fail:_notification.default.exception}])[0],element=await this.renderTemplate("mootimetertool_quiz/answer_option",{aoid:result.aoid,isediting:!0,ispoll:this.isPoll(),isquiz:!this.isPoll()});questionElements.append(...element.children)}}isPoll(){return"1"===this.page.config.ispoll}async renderResult(){_templates.default.prefetchTemplates(["mootimetertool_quiz/view_results"]);const page=this.page,ajax=_ajax.default.call([{methodname:"mootimetertool_quiz_get_answeroptions",args:{pageid:page.id},fail:_notification.default.exception},{methodname:"mootimetertool_quiz_get_answers",args:{pageid:page.id},fail:_notification.default.exception}]),answeroptions=await ajax[0],answers=await ajax[1],data={labels:[],datasets:[{label:page.question,data:[]}]},answermapping={};for(let i=0;i<answeroptions.length;i++)data.labels.push(answeroptions[i].optiontext),answermapping[answeroptions[i].id]=i;data.datasets[0].data=new Array(data.labels.length);for(const answer of answers.answerlist)data.datasets[0].data[answermapping[answer.optionid]]=answer.count;const element=await this.renderTemplate("mootimetertool_quiz/view_results",{}),canvas=element.querySelector("#quizcanvas");return new _chartjs.default(canvas,{type:"bar",data:data,options:{responsive:!0,maintainAspectRatio:!1}}).update(),element}}return _exports.default=Tool,_exports.default}));

//# sourceMappingURL=tool.min.js.map